<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facturaci√≥n Gastrosat</title>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.js"></script>
    
    <link rel="stylesheet" type="text/css" href="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.css" />

    <script>
        // üîπ Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAst9f2-Jro1d4OX0henL8OeKXT4Ds35uA",
            authDomain: "factu-f58ab.firebaseapp.com",
            projectId: "factu-f58ab",
            storageBucket: "factu-f58ab.firebasestorage.app",
            messagingSenderId: "126560099435",
            appId: "1:126560099435:web:483f6c5d68ab3217c3652e",
            measurementId: "G-MC2S07WMSL"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // üîπ Correo permitido
        const emailPermitido = "aesg.alexis@gmail.com";

        // üîπ Inicializar FirebaseUI
        function iniciarFirebaseUI() {
            const ui = new firebaseui.auth.AuthUI(firebase.auth());
            ui.start('#firebaseui-auth-container', {
                signInOptions: [
                    firebase.auth.GoogleAuthProvider.PROVIDER_ID
                ],
                signInFlow: "popup",
                callbacks: {
                    signInSuccessWithAuthResult: function(authResult) {
                        const user = authResult.user;
                        if (user.email === emailPermitido) {
                            document.getElementById("contenido").style.display = "block";
                            document.getElementById("login-container").style.display = "none";
                        } else {
                            alert("Acceso denegado.");
                            firebase.auth().signOut();
                        }
                        return false;
                    }
                }
            });
        }

        // üîπ Detectar cambios en autenticaci√≥n
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                if (user.email === emailPermitido) {
                    document.getElementById("contenido").style.display = "block";
                    document.getElementById("login-container").style.display = "none";
                    cargarClientes();
                } else {
                    firebase.auth().signOut();
                    document.getElementById("contenido").style.display = "none";
                    document.getElementById("login-container").style.display = "block";
                    iniciarFirebaseUI();
                }
            } else {
                document.getElementById("contenido").style.display = "none";
                document.getElementById("login-container").style.display = "block";
                iniciarFirebaseUI();
            }
        });

        // üîπ Guardar Cliente
        function guardarCliente() {
            const nombre = document.getElementById("cliente-nombre").value;
            const nombreFiscal = document.getElementById("cliente-nombre-fiscal").value;
            const direccion = document.getElementById("cliente-direccion").value;
            const cif = document.getElementById("cliente-cif").value;
            const telefono = document.getElementById("cliente-telefono").value || "";
            const email = document.getElementById("cliente-email").value || "";

            if (!nombre || !nombreFiscal || !direccion || !cif) {
                alert("Completa los campos obligatorios.");
                return;
            }

            const clienteId = Date.now().toString(); // ID √∫nico basado en timestamp

            db.collection("clientes").doc(clienteId).set({
                clienteId: clienteId,
                nombre: nombre,
                nombreFiscal: nombreFiscal,
                direccion: direccion,
                cif: cif,
                telefono: telefono,
                email: email,
                creado: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                alert("Cliente agregado correctamente.");
                document.getElementById("cliente-form").reset();
                cargarClientes();
            })
            .catch(error => {
                console.error("Error al guardar cliente:", error);
                alert("Error al guardar cliente.");
            });
        }

        // üîπ Cargar Clientes
        function cargarClientes() {
            const lista = document.getElementById("lista-clientes");
            lista.innerHTML = ""; // Limpiar lista

            db.collection("clientes").orderBy("creado", "desc").get().then(snapshot => {
                snapshot.forEach(doc => {
                    const cliente = doc.data();
                    const li = document.createElement("li");
                    li.innerHTML = `
                        <strong>${cliente.nombre}</strong> (${cliente.nombreFiscal})<br>
                        ${cliente.direccion} - ${cliente.cif}<br>
                        üìû ${cliente.telefono || "No especificado"} - üìß ${cliente.email || "No especificado"}
                        <button onclick="eliminarCliente('${doc.id}')">‚ùå</button>
                    `;
                    lista.appendChild(li);
                });
            });
        }

        // üîπ Eliminar Cliente
        function eliminarCliente(clienteId) {
            if (confirm("¬øSeguro que quieres eliminar este cliente?")) {
                db.collection("clientes").doc(clienteId).delete()
                .then(() => {
                    alert("Cliente eliminado.");
                    cargarClientes();
                })
                .catch(error => {
                    console.error("Error al eliminar cliente:", error);
                });
            }
        }

        // üîπ Cerrar Sesi√≥n
        function logout() {
            firebase.auth().signOut().then(() => {
                document.getElementById("contenido").style.display = "none";
                document.getElementById("login-container").style.display = "block";
                iniciarFirebaseUI();
            });
        }
    </script>

    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 20px; text-align: center; }
        input, button { width: 90%; padding: 8px; margin: 5px; }
        ul { list-style: none; padding: 0; }
        li { border: 1px solid #ddd; padding: 10px; margin: 5px; text-align: left; position: relative; }
        button { background-color: red; color: white; border: none; cursor: pointer; position: absolute; right: 10px; top: 10px; }
    </style>
</head>
<body>

    <div id="login-container">
        <h2>Iniciar Sesi√≥n</h2>
        <div id="firebaseui-auth-container"></div>
    </div>

    <div id="contenido">
        <h2>Clientes - Facturaci√≥n Gastrosat</h2>
        <button onclick="logout()">Cerrar sesi√≥n</button>

        <h3>Agregar Cliente</h3>
        <form id="cliente-form">
            <input type="text" id="cliente-nombre" placeholder="Nombre *">
            <input type="text" id="cliente-nombre-fiscal" placeholder="Nombre Fiscal *">
            <input type="text" id="cliente-direccion" placeholder="Direcci√≥n *">
            <input type="text" id="cliente-cif" placeholder="CIF *">
            <input type="text" id="cliente-telefono" placeholder="Tel√©fono">
            <input type="email" id="cliente-email" placeholder="Correo Electr√≥nico">
            <button type="button" onclick="guardarCliente()">Guardar Cliente</button>
        </form>

        <h3>Lista de Clientes</h3>
        <ul id="lista-clientes"></ul>
    </div>

</body>
</html>
