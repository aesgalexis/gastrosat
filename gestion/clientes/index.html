<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clientes - GastroSat</title>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>

    <script>
        // 🔹 Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAst9f2-Jro1d4OX0henL8OeKXT4Ds35uA",
            authDomain: "factu-f58ab.firebaseapp.com",
            projectId: "factu-f58ab",
            storageBucket: "factu-f58ab.firebasestorage.app",
            messagingSenderId: "126560099435",
            appId: "1:126560099435:web:483f6c5d68ab3217c3652e",
            measurementId: "G-MC2S07WMSL"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // 🔹 Verificar autenticación antes de usar Firestore
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                cargarClientes();
            } else {
                window.location.href = "../";
            }
        });

        // 🔹 Guardar Cliente en Firestore
        function guardarCliente() {
            const nombre = document.getElementById("cliente-nombre").value;
            const nombreFiscal = document.getElementById("cliente-nombre-fiscal").value;
            const direccion = document.getElementById("cliente-direccion").value;
            const cif = document.getElementById("cliente-cif").value;
            const telefono = document.getElementById("cliente-telefono").value || "";
            const email = document.getElementById("cliente-email").value || "";

            if (!nombre || !nombreFiscal || !direccion || !cif) {
                alert("Completa los campos obligatorios.");
                return;
            }

            db.collection("clientes").add({
                nombre: nombre,
                nombreFiscal: nombreFiscal,
                direccion: direccion,
                cif: cif,
                telefono: telefono,
                email: email,
                creado: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                alert("Cliente agregado correctamente.");
                document.getElementById("cliente-form").reset();
                cargarClientes();
            })
            .catch(error => {
                console.error("Error al guardar cliente:", error);
                alert("Error al guardar cliente.");
            });
        }

        // 🔹 Cargar Clientes desde Firestore
        function cargarClientes() {
            const lista = document.getElementById("lista-clientes");
            lista.innerHTML = "";

            db.collection("clientes").orderBy("creado", "desc").get()
            .then(snapshot => {
                snapshot.forEach(doc => {
                    const cliente = doc.data();
                    const li = document.createElement("li");
                    li.classList.add("cliente-item");
                    li.innerHTML = `
                        <div class="cliente-info">
                            <strong>${cliente.nombre}</strong> (${cliente.nombreFiscal})<br>
                            ${cliente.direccion} - ${cliente.cif}<br>
                            📞 ${cliente.telefono || "No especificado"} - 📧 ${cliente.email || "No especificado"}
                        </div>
                        <button class="eliminar-btn" onclick="eliminarCliente('${doc.id}')">❌</button>
                    `;
                    lista.appendChild(li);
                });
            })
            .catch(error => {
                console.error("Error al cargar clientes:", error);
            });
        }

        // 🔹 Eliminar Cliente de Firestore
        function eliminarCliente(clienteId) {
            if (confirm("¿Seguro que quieres eliminar este cliente?")) {
                db.collection("clientes").doc(clienteId).delete()
                .then(() => {
                    alert("Cliente eliminado.");
                    cargarClientes();
                })
                .catch(error => {
                    console.error("Error al eliminar cliente:", error);
                });
            }
        }
    </script>

    <style>
        body { font-family: Arial, sans-serif; max-width: 500px; margin: auto; padding: 20px; text-align: center; }
        input, button { width: 100%; padding: 10px; margin: 5px 0; font-size: 16px; border-radius: 12px; border: 1px solid #ddd; }
        button { background-color: #007BFF; color: white; cursor: pointer; transition: 0.3s; }
        button:hover { background-color: #0056b3; }
        ul { list-style: none; padding: 0; }
        .cliente-item { border: 1px solid #ddd; border-radius: 12px; padding: 15px; margin: 10px 0; text-align: left; display: flex; justify-content: space-between; align-items: center; }
        .cliente-info { flex-grow: 1; }
        .eliminar-btn { background-color: red; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 8px; }
        .eliminar-btn:hover { background-color: darkred; }
    </style>
</head>
<body>

    <h2>Gestión de Clientes</h2>
    <button onclick="window.location.href='../'">🔙 Volver</button>

    <h3>Agregar Cliente</h3>
    <form id="cliente-form">
        <input type="text" id="cliente-nombre" placeholder="Nombre *">
        <input type="text" id="cliente-nombre-fiscal" placeholder="Nombre Fiscal *">
        <input type="text" id="cliente-direccion" placeholder="Dirección *">
        <input type="text" id="cliente-cif" placeholder="CIF *">
        <input type="text" id="cliente-telefono" placeholder="Teléfono">
        <input type="email" id="cliente-email" placeholder="Correo Electrónico">
        <button type="button" onclick="guardarCliente()">Guardar Cliente</button>
    </form>

    <h3>Lista de Clientes</h3>
    <ul id="lista-clientes"></ul>

</body>
</html>
