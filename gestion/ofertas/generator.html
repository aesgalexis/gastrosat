<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de PDF - GastroSat</title>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>

    <!-- jsPDF y html2canvas para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: auto; padding: 20px; text-align: center; }
        .pdf-container { background: white; padding: 20px; border: 1px solid #ddd; border-radius: 12px; text-align: left; }
        .header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; border-bottom: 2px solid #000; }
        .company-info { text-align: right; }
        .content { margin-top: 20px; }
        .total { font-size: 18px; font-weight: bold; text-align: right; margin-top: 10px; }
        button { background-color: #007BFF; color: white; padding: 10px; border: none; border-radius: 12px; cursor: pointer; margin-top: 20px; }
        button:hover { background-color: #0056b3; }
    </style>
</head>
<body>

    <h2>Generar PDF de Oferta</h2>
    <button onclick="window.location.href='../'">üîô Volver</button>

    <label>Selecciona una oferta:</label>
    <select id="oferta-select" onchange="cargarDatosOferta()"></select>

    <!-- üìÑ Plantilla para el PDF -->
    <div id="pdf-content" class="pdf-container">
        <div class="header">
            <h2>Oferta - GastroSat</h2>
            <div class="company-info">
                <p><strong>GastroSat</strong></p>
                <p>Direcci√≥n de la empresa</p>
                <p>Tel√©fono | Email</p>
            </div>
        </div>

        <h3>Oferta: <span id="oferta-id">-</span></h3>
        <p><strong>Fecha:</strong> <span id="oferta-fecha">-</span></p>

        <div class="content">
            <h4>Datos del Cliente</h4>
            <p><strong>Nombre:</strong> <span id="oferta-nombre">-</span></p>
            <p><strong>Nombre Fiscal:</strong> <span id="oferta-nombre-fiscal">-</span></p>
            <p><strong>Direcci√≥n:</strong> <span id="oferta-direccion">-</span></p>
            <p><strong>CIF:</strong> <span id="oferta-cif">-</span></p>
        </div>

        <h4>Descripci√≥n de la Oferta</h4>
        <p id="oferta-descripcion">-</p>

        <h4>Importe Total</h4>
        <p class="total"><strong>Total: </strong> <span id="oferta-importe">-</span> ‚Ç¨</p>

        <h4>Estado de la Oferta</h4>
        <p><span id="oferta-estado">-</span></p>
    </div>

    <button onclick="generarPDF()">üìÑ Descargar PDF</button>

    <script>
        // üîπ Verifica si Firebase ya est√° inicializado antes de usarlo
        if (!firebase.apps.length) {
            const firebaseConfig = {
                apiKey: "AIzaSyAst9f2-Jro1d4OX0henL8OeKXT4Ds35uA",
                authDomain: "factu-f58ab.firebaseapp.com",
                projectId: "factu-f58ab",
                storageBucket: "factu-f58ab.firebasestorage.app",
                messagingSenderId: "126560099435",
                appId: "1:126560099435:web:483f6c5d68ab3217c3652e",
                measurementId: "G-MC2S07WMSL"
            };
            firebase.initializeApp(firebaseConfig);
        }

        // üîπ Inicializar Firestore y Auth
        const db = firebase.firestore();
        const auth = firebase.auth();

        // üîπ Detectar cambios en autenticaci√≥n
        auth.onAuthStateChanged(user => {
            if (user) {
                console.log("‚úÖ Usuario autenticado:", user.email);
                cargarOfertas();
            } else {
                console.error("‚ùå Usuario no autenticado, redirigiendo...");
                window.location.href = "../"; // Redirigir si no est√° autenticado
            }
        });

        // üîπ Cargar ofertas disponibles
        function cargarOfertas() {
            const ofertaSelect = document.getElementById("oferta-select");
            ofertaSelect.innerHTML = "<option value=''>Cargando ofertas...</option>";

            db.collection("ofertas").orderBy("fecha", "desc").get()
            .then(snapshot => {
                if (snapshot.empty) {
                    console.warn("‚ö†Ô∏è No hay ofertas en Firestore.");
                    ofertaSelect.innerHTML = "<option value=''>No hay ofertas disponibles</option>";
                    return;
                }

                ofertaSelect.innerHTML = "<option value=''>Seleccione una oferta</option>";

                snapshot.forEach(doc => {
                    const oferta = doc.data();
                    const option = document.createElement("option");
                    option.value = doc.id;
                    option.textContent = `${oferta.ofertaId} - ${oferta.nombre}`;
                    ofertaSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error("‚ùå Error al cargar ofertas:", error);
                ofertaSelect.innerHTML = "<option value=''>Error al cargar ofertas</option>";
            });
        }

        // üîπ Cargar datos de la oferta seleccionada
        function cargarDatosOferta() {
            const ofertaId = document.getElementById("oferta-select").value;
            if (!ofertaId) return;

            db.collection("ofertas").doc(ofertaId).get().then(doc => {
                if (doc.exists) {
                    const oferta = doc.data();
                    document.getElementById("oferta-id").textContent = oferta.ofertaId;
                    document.getElementById("oferta-fecha").textContent = oferta.fecha;
                    document.getElementById("oferta-nombre").textContent = oferta.nombre;
                    document.getElementById("oferta-nombre-fiscal").textContent = oferta.nombreFiscal;
                    document.getElementById("oferta-direccion").textContent = oferta.direccion;
                    document.getElementById("oferta-cif").textContent = oferta.cif;
                    document.getElementById("oferta-descripcion").textContent = oferta.descripcion;
                    document.getElementById("oferta-importe").textContent = oferta.importe + " ‚Ç¨";
                    document.getElementById("oferta-estado").textContent = oferta.estado;
                }
            });
        }

        // üîπ Generar PDF con html2canvas
        function generarPDF() {
            const { jsPDF } = window.jspdf;

            html2canvas(document.getElementById("pdf-content"), { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL("image/png");
                const doc = new jsPDF("p", "mm", "a4");

                doc.addImage(imgData, "PNG", 10, 10, 190, 0);
                doc.save("Oferta_GastroSat.pdf");
            });
        }
    </script>
</body>
</html>
