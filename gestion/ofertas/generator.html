<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generar PDF - GastroSat</title>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>

    <!-- jsPDF para generaci√≥n de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 0; padding: 0; }
        #contenedor { display: flex; flex-direction: column; align-items: center; padding: 20px; }
        #vista-previa { 
            width: 210mm; height: 297mm; padding: 20mm; 
            border: 1px solid #ddd; background: white; box-shadow: 0 0 10px rgba(0,0,0,0.1); 
            display: flex; flex-direction: column; align-items: flex-start; text-align: left;
        }
        #logo { width: 100px; }
        .info { width: 100%; display: flex; justify-content: space-between; margin-bottom: 20px; }
        .separador { width: 100%; border-top: 2px solid #000; margin: 10px 0; }
        .detalle { font-size: 14px; }
        button { background-color: #007BFF; color: white; padding: 10px; border: none; border-radius: 12px; cursor: pointer; margin-top: 20px; }
        button:hover { background-color: #0056b3; }
    </style>
</head>
<body>

    <h2>Vista Previa de la Oferta</h2>
    <button onclick="window.history.back()">üîô Volver</button>

    <div id="contenedor">
        <!-- üîπ Previsualizaci√≥n en formato A4 -->
        <div id="vista-previa">
            <div class="info">
                <img id="logo" src="/logo5.png" alt="Logo">
                <div>
                    <p><strong>Empresa:</strong> GastroSat</p>
                    <p><strong>Direcci√≥n:</strong> -----------------</p>
                    <p><strong>Tel√©fono:</strong> -----------------</p>
                    <p><strong>Email:</strong> -----------------</p>
                </div>
                <div>
                    <p><strong>Cliente:</strong> <span id="oferta-nombre"></span></p>
                    <p><strong>Fiscal:</strong> <span id="oferta-nombre-fiscal"></span></p>
                    <p><strong>Direcci√≥n:</strong> <span id="oferta-direccion"></span></p>
                    <p><strong>CIF:</strong> <span id="oferta-cif"></span></p>
                </div>
            </div>

            <div class="separador"></div>
            
            <h3>Descripci√≥n de la Oferta</h3>
            <p id="oferta-descripcion" class="detalle"></p>

            <div class="separador"></div>

            <p><strong>Importe Total:</strong> <span id="oferta-importe"></span> ‚Ç¨</p>
            <p><strong>Estado:</strong> <span id="oferta-estado"></span></p>
        </div>
    </div>

    <button onclick="generarPDF()">üìÑ Descargar PDF</button>

    <script>
        // üîπ Verifica si Firebase ya est√° inicializado antes de usarlo
        if (!firebase.apps.length) {
            const firebaseConfig = {
                apiKey: "AIzaSyAst9f2-Jro1d4OX0henL8OeKXT4Ds35uA",
                authDomain: "factu-f58ab.firebaseapp.com",
                projectId: "factu-f58ab",
                storageBucket: "factu-f58ab.firebasestorage.app",
                messagingSenderId: "126560099435",
                appId: "1:126560099435:web:483f6c5d68ab3217c3652e",
                measurementId: "G-MC2S07WMSL"
            };
            firebase.initializeApp(firebaseConfig);
        }

        // üîπ Inicializar Firestore y Auth
        const db = firebase.firestore();
        const auth = firebase.auth();

        // üîπ Obtener `ofertaId` de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const ofertaId = urlParams.get("ofertaId");

        // üîπ Cargar y mostrar la oferta
        function cargarOferta() {
            if (!ofertaId) {
                alert("‚ùå No se encontr√≥ una oferta v√°lida.");
                window.history.back();
                return;
            }

            db.collection("ofertas").doc(ofertaId).get()
            .then(doc => {
                if (!doc.exists) {
                    alert("‚ùå La oferta no existe.");
                    window.history.back();
                    return;
                }

                const oferta = doc.data();
                document.getElementById("oferta-nombre").textContent = oferta.nombre;
                document.getElementById("oferta-nombre-fiscal").textContent = oferta.nombreFiscal;
                document.getElementById("oferta-direccion").textContent = oferta.direccion;
                document.getElementById("oferta-cif").textContent = oferta.cif;
                document.getElementById("oferta-descripcion").textContent = oferta.descripcion;
                document.getElementById("oferta-importe").textContent = oferta.importe;
                document.getElementById("oferta-estado").textContent = oferta.estado;
            })
            .catch(error => console.error("‚ùå Error al cargar la oferta:", error));
        }

        // üîπ Generar y descargar PDF
        function generarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ format: "a4" });

            // üîπ Logo
            const img = new Image();
            img.src = "/logo5.png";

            img.onload = function () {
                doc.addImage(img, "PNG", 20, 15, 50, 20);

                // üîπ Datos de la empresa
                doc.setFontSize(12);
                doc.text("Empresa: GastroSat", 20, 45);
                doc.text("Direcci√≥n: ---------------", 20, 55);
                doc.text("Tel√©fono: ---------------", 20, 65);
                doc.text("Email: ---------------", 20, 75);

                // üîπ Datos del cliente
                doc.text("Cliente: " + document.getElementById("oferta-nombre").textContent, 120, 45);
                doc.text("Fiscal: " + document.getElementById("oferta-nombre-fiscal").textContent, 120, 55);
                doc.text("Direcci√≥n: " + document.getElementById("oferta-direccion").textContent, 120, 65);
                doc.text("CIF: " + document.getElementById("oferta-cif").textContent, 120, 75);

                // üîπ Separador
                doc.line(20, 85, 190, 85);

                // üîπ Descripci√≥n
                doc.setFontSize(14);
                doc.text("Descripci√≥n de la Oferta:", 20, 95);
                doc.setFontSize(12);
                const desc = doc.splitTextToSize(document.getElementById("oferta-descripcion").textContent, 160);
                doc.text(desc, 20, 105);

                // üîπ Guardar PDF
                doc.save(`Oferta_${ofertaId}.pdf`);
            };
        }

        // üîπ Cargar oferta al abrir la p√°gina
        window.onload = cargarOferta;
    </script>
</body>
</html>
