<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ofertas - GastroSat</title>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>

    <!-- jsPDF y html2canvas para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // 🔹 Inicializar Firebase si no está inicializado
        if (!firebase.apps.length) {
            const firebaseConfig = {
                apiKey: "AIzaSyAst9f2-Jro1d4OX0henL8OeKXT4Ds35uA",
                authDomain: "factu-f58ab.firebaseapp.com",
                projectId: "factu-f58ab",
                storageBucket: "factu-f58ab.firebasestorage.app",
                messagingSenderId: "126560099435",
                appId: "1:126560099435:web:483f6c5d68ab3217c3652e",
                measurementId: "G-MC2S07WMSL"
            };
            firebase.initializeApp(firebaseConfig);
        }

        // 🔹 Inicializar Firestore y Auth
        const db = firebase.firestore();
        const auth = firebase.auth();

        // 🔹 Detectar cambios en autenticación
        auth.onAuthStateChanged(user => {
            if (user) {
                console.log("Usuario autenticado:", user.email);
                cargarClientes();
            } else {
                console.log("Usuario no autenticado, redirigiendo...");
                window.location.href = "../";
            }
        });

        // 🔹 Cargar clientes en el selector
        function cargarClientes() {
            console.log("Intentando cargar clientes...");
            const clienteSelect = document.getElementById("oferta-cliente");
            clienteSelect.innerHTML = "<option value=''>Cargando clientes...</option>";

            db.collection("clientes").get()
            .then(snapshot => {
                console.log("Clientes obtenidos:", snapshot.docs.length);
                clienteSelect.innerHTML = "<option value=''>Seleccione un cliente</option>";

                snapshot.forEach(doc => {
                    console.log("Cliente encontrado:", doc.data());
                    const cliente = doc.data();
                    const option = document.createElement("option");
                    option.value = doc.id;
                    option.textContent = `${cliente.nombre} (${cliente.cif})`;
                    clienteSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error("Error al cargar clientes:", error);
                clienteSelect.innerHTML = "<option value=''>Error al cargar clientes</option>";
            });
        }

        // 🔹 Autocompletar datos del cliente seleccionado
        function autocompletarCliente() {
            const clienteId = document.getElementById("oferta-cliente").value;

            if (!clienteId) {
                document.getElementById("oferta-nombre").value = "";
                document.getElementById("oferta-nombre-fiscal").value = "";
                document.getElementById("oferta-direccion").value = "";
                document.getElementById("oferta-cif").value = "";
                return;
            }

            db.collection("clientes").doc(clienteId).get().then(doc => {
                if (doc.exists) {
                    const cliente = doc.data();
                    document.getElementById("oferta-nombre").value = cliente.nombre;
                    document.getElementById("oferta-nombre-fiscal").value = cliente.nombreFiscal;
                    document.getElementById("oferta-direccion").value = cliente.direccion;
                    document.getElementById("oferta-cif").value = cliente.cif;
                }
            });
        }

        // 🔹 Guardar Oferta en Firestore
        function guardarOferta() {
            const clienteId = document.getElementById("oferta-cliente").value;
            const nombre = document.getElementById("oferta-nombre").value;
            const nombreFiscal = document.getElementById("oferta-nombre-fiscal").value;
            const direccion = document.getElementById("oferta-direccion").value;
            const cif = document.getElementById("oferta-cif").value;
            const descripcion = document.getElementById("oferta-descripcion").value;
            const importe = document.getElementById("oferta-importe").value;
            const estado = document.getElementById("oferta-estado").value;

            if (!clienteId || !descripcion || !importe) {
                alert("Seleccione un cliente y complete los campos obligatorios.");
                return;
            }

            const fecha = new Date().toISOString().split("T")[0];
            const ofertaId = `OF-${fecha.replace(/-/g, "")}-${Math.floor(1000 + Math.random() * 9000)}`;

            db.collection("ofertas").doc(ofertaId).set({
                ofertaId: ofertaId,
                clienteId: clienteId,
                nombre: nombre,
                nombreFiscal: nombreFiscal,
                direccion: direccion,
                cif: cif,
                fecha: fecha,
                descripcion: descripcion,
                importe: parseFloat(importe),
                estado: estado
            })
            .then(() => {
                alert("Oferta guardada correctamente.");
                document.getElementById("oferta-form").reset();
            })
            .catch(error => {
                console.error("Error al guardar la oferta:", error);
                alert("Error al guardar la oferta.");
            });
        }

        // 🔹 Generar PDF de la oferta
        function generarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(16);
            doc.text("OFERTA - GASTROSAT", 20, 20);

            doc.setFontSize(12);
            doc.text(`Cliente: ${document.getElementById("oferta-nombre").value}`, 20, 30);
            doc.text(`Nombre Fiscal: ${document.getElementById("oferta-nombre-fiscal").value}`, 20, 40);
            doc.text(`Dirección: ${document.getElementById("oferta-direccion").value}`, 20, 50);
            doc.text(`CIF: ${document.getElementById("oferta-cif").value}`, 20, 60);
            doc.text(`Descripción: ${document.getElementById("oferta-descripcion").value}`, 20, 70);
            doc.text(`Importe Total: ${document.getElementById("oferta-importe").value} €`, 20, 80);
            doc.text(`Estado: ${document.getElementById("oferta-estado").value}`, 20, 90);

            doc.save("Oferta_GastroSat.pdf");
        }
    </script>

    <style>
        body { font-family: Arial, sans-serif; max-width: 500px; margin: auto; padding: 20px; text-align: center; }
        input, select, textarea, button { width: 100%; padding: 10px; margin: 5px 0; font-size: 16px; border-radius: 12px; border: 1px solid #ddd; }
        button { background-color: #007BFF; color: white; cursor: pointer; transition: 0.3s; }
        button:hover { background-color: #0056b3; }
    </style>
</head>
<body>

    <h2>Gestión de Ofertas</h2>
    <button onclick="window.location.href='../'">🔙 Volver</button>
    <button onclick="generarPDF()">📄 Generar PDF</button>

</body>
</html>
